# Guide to H.264 streaming

µStreamer supports bandwidth-efficient streaming using [H.264 compression](https://en.wikipedia.org/wiki/Advanced_Video_Coding) and the Janus WebRTC server. This guide explains how to configure µStreamer to stream with H264+WebRTC and how to consume that stream within a web application.

## Components and Control Flow

In addition to µStreamer itself, the following components are involved:

- [**Janus**](https://janus.conf.meetecho.com/): A general-purpose WebRTC server. Its purpose is to facilitate the WebRTC connection and communication, but it doesn’t know anything about µStreamer or any other media supplier.
- [**µStreamer plugin for Janus**](https://github.com/pikvm/ustreamer/tree/master/janus): A plugin to link µStreamer and Janus, and that provides the video data via shared memory from µStreamer.
- [**Janus JavaScript-Client**](https://janus.conf.meetecho.com/docs/JS.html): A frontend library for connecting to the Janus server, and to exchange commands and data with the µStreamer plugin.

This is a high-level overview of the control flow:

1. Server starts the µStreamer service.
1. Server starts the Janus WebRTC service with the µStreamer plugin.
1. Client-side JavaScript application establishes a connection to the Janus server.
1. Client-side JavaScript application instructs Janus server to attach the µStreamer plugin and start the video stream.

## Server Setup

### Prerequisites

The following prerequisites should be installed on the server:

- The system packages that µStreamer depends on, see [µStreamer documentation](https://github.com/pikvm/ustreamer).
- The Janus WebRTC server, see [Janus documentation](https://github.com/meetecho/janus-gateway).

### Installation

First, compile µStreamer together with the Janus plugin.

```sh
git clone --depth=1 https://github.com/pikvm/ustreamer
cd ustreamer
make WITH_OMX=1 WITH_JANUS=1
```

// TODO How to move compiled plugin to destination

// TODO Where and how to set up config files

### Start up Janus and µStreamer

// TODO commands for starting µStreamer, and Janus incl. the plugin

## Client Setup

### Prerequisites

The client needs to load the following JavaScript libraries:

- [The WebRTC Adapter library](https://webrtc.github.io/adapter/adapter-8.1.0.js) (`webrtc-adapter.js`, version `8.1.0`)
- [The JavaScript library of Janus Gateway](https://raw.githubusercontent.com/meetecho/janus-gateway/v1.0.0/html/janus.js) (`janus.js`, version `1.0.0`)

### Control Flow

The only HTML we need is a `<video>` element for rendering the H.264 video stream.

The control flow in the client-side JavaScript application is this:

1. The client loads and initiates the Janus client library, and establishes a network connection to the Janus server.
1. The client instructs the server to attach the µStreamer plugin.
1. On success, the client obtains a handle through which it can send requests to the µStreamer plugin directly. The responses are processed via the `attach` callbacks, in this case:
   - `onmessage` callback for general messages
   - `onremotetrack` for the H.264 video stream
1. The client issues a `watch` request to the µStreamer plugin, which initiates the H.264 stream in the plugin itself. When attaching the plugin for the first time, this doesn’t immediately succeed, but it takes a few seconds for the H.264 media to become available. The client has to retry the `watch` request in this case.
1. Once the H.264 media is available for streaming in the µStreamer plugin, client and server have to negotiate the underlying parameters for the WebRTC session. This mechanism is called JSEP (JavaScript Session Establishment Protocol), where the server makes a `jsepOffer` to the client, and the client responds with an `jsepAnswer`.
1. After the JSEP exchange has taken place, the WebRTC connection is eventually established, and the µStreamer plugin begins delivering the H.264 video stream to the client via WebRTC.
1. Once the video data starts to arrive on the client, the `onremotetrack` callback is invoked. The client attaches the received stream track to the `<video>` element. This will render the video stream on the screen.

### Sample Code

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>µStreamer H.264 guide</title>
  <script src="https://webrtc.github.io/adapter/adapter-8.1.0.js"></script>
  <script src="janus.js"></script>
  <style>
    video {
      height: 100%;
      width: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <video id="webrtc-output" autoplay playsinline muted></video>
  <script type="text/javascript">
    const videoElement = document.getElementById("webrtc-output");

    // Initialize Janus library.
    Janus.init({
      // Turn on debug logs in the browser console.
      debug: true,

      // Configure Janus to use standard browser APIs internally.
      dependencies: Janus.useDefaultDependencies(),
    });

    // Establish a connection to the server.
    const janus = new Janus({
      // The URL of the server’s websocket endpoint.
      server: 'ws://raspberrypi/janus/ws',

      // Callback function, when the client connected successfully.
      success: attachJanusPlugin,

      // Callback function, when the client failed to connect.
      error: console.error,
    });

    let janusPluginHandle = null;

    function attachJanusPlugin() {
      // Instruct server to attach the µStreamer plugin.
      janus.attach({
        // Qualifier of the plugin.
        plugin: "janus.plugin.ustreamer",

        // Callback function, when the server attached the plugin successfully.
        success: function (pluginHandle) {
          janusPluginHandle = pluginHandle;
          // Instruct the µStreamer plugin to initiate H.264 stream.
          janusPluginHandle.send({ message: { request: "watch" } });
        },

        // Callback function, when the server failed to attach the plugin.
        error: console.error,

        // Callback function, when a message arrived from the server.
        onmessage: function (msg, jsepOffer) {
          // Retry watch request, until the H.264 stream is available.
          if (msg.error_code === 503) {
            janusPluginHandle.send({ message: { request: "watch" } });
            return;
          }

          // Once the JSEP offer is there, instruct the server to start the
          // delivery of the H.264 stream.
          if (jsepOffer) {
            janusPluginHandle.createAnswer({
              jsep: jsepOffer,
              media: { audioSend: false, videoSend: false, data: false },
              success: function (jsepAnswer) {
                janusPluginHandle.send({
                  message: {},
                  jsep: jsepAnswer,
                });
              },
              error: console.error,
            });
          }
        },

        // Callback function, when the video stream has become available.
        onremotetrack: function (track, mediaId, isAdded) {
          if (isAdded) {
            // Attach the received media track to the video element.
            const stream = new MediaStream();
            stream.addTrack(track.clone());
            videoElement.srcObject = stream;
          }
        },
      });
    }
  </script>
</body>
</html>
```
