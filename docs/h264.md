# Guide to H.264 streaming

µStreamer supports bandwidth-efficient streaming using [H.264 compression](https://en.wikipedia.org/wiki/Advanced_Video_Coding) and the Janus WebRTC server. This guide explains how to configure µStreamer to stream with H264+WebRTC and how to consume that stream within a web application.

## Components and Control Flow

In addition to µStreamer itself, the following components are involved:

- [**Janus**](https://janus.conf.meetecho.com/): A general-purpose WebRTC server. Its purpose is to facilitate the WebRTC connection and communication, but it doesn’t know anything about µStreamer or any other media supplier.
- [**µStreamer plugin for Janus**](https://github.com/pikvm/ustreamer/tree/master/janus): A plugin to link µStreamer and Janus, and that provides the video data via shared memory from µStreamer.
- [**Janus JavaScript-Client**](https://janus.conf.meetecho.com/docs/JS.html): A frontend library for connecting to the Janus server, and to exchange commands and data with the µStreamer plugin.

This is a high-level overview of the control flow:

1. On the server, start the µStreamer service.
1. Start up the Janus WebRTC server with the µStreamer plugin.
1. On the client, establish a connection to the Janus server.
1. Ask the Janus server to attach the µStreamer plugin and start the video stream.

## Server Setup

TODO:
### Setup Janus WebRTC server

Please follow [the instructions given in the Janus documentation](https://github.com/meetecho/janus-gateway).

- Install µStreamer and Janus
  + Compile µStreamer with Janus option
  + Put config files in place
- Launch µStreamer and Janus

## Client Setup

As prerequisites, you need to provide two JavaScript libraries:

- [The WebRTC Adapter library](https://webrtc.github.io/adapter/adapter-8.1.0.js) (`webrtc-adapter.js`, version `8.1.0`)
- [The JavaScript library of Janus Gateway](https://raw.githubusercontent.com/meetecho/janus-gateway/v1.0.0/html/janus.js) (`janus.js`, version `1.0.0`)

The only HTML we need is a `<video>` element for rendering the H.264 video stream.

The control flow is this:

1. Initiate the Janus client library.
1. Establish a connection to the Janus server.
1. Ask the server to attach the µStreamer plugin.
1. On success, we obtain a handle through which we can send requests to the µStreamer plugin directly. The responses are processed via the `attach` callbacks, in our case:
   - `onmessage` callback for general messages
   - `onremotetrack` for the video stream
1. Send a `watch` request to the µStreamer plugin. This initiates the H.264 stream in the plugin itself. For the very first call after starting the plugin, this doesn’t immediately succeed. It takes a few seconds until the stream becomes available. Therefore, we have to retry the request, until the plugin indicates that it’s ready. It does that by generating a JSEP offer, obtained via the `jsepOffer` parameter in the `onmessage` callback.
1. With that in place, we can send back a JSEP answer in which we issue a `start` request to the µStreamer plugin. That will make the server begin streaming the H.264 video signal.
1. Once the video data starts to arrive on the client, the `onremotetrack` callback is invoked. The received `track` object can be attached to the `<video>` element, which eventually displays the video on the screen.

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>µStreamer H.264 guide</title>
  <script src="https://webrtc.github.io/adapter/adapter-8.1.0.js"></script>
  <script src="janus.js"></script>
  <style>
    video {
      height: 100%;
      width: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <video id="webrtc-output" autoplay playsinline muted></video>
  <script type="text/javascript">
    const videoElement = document.getElementById("webrtc-output");

    // Initialize Janus library.
    Janus.init({
      // Turn on debug logs in the browser console.
      debug: true,

      // Configure Janus to use standard browser APIs internally.
      dependencies: Janus.useDefaultDependencies(),
    });

    // Establish a connection to the server.
    const janus = new Janus({
      // The URL of the server’s websocket endpoint.
      server: 'ws://raspberrypi/janus/ws',

      // Callback function, when the client connected successfully.
      success: attachJanusPlugin,

      // Callback function, when the client failed to connect.
      error: console.error,
    });

    let janusPluginHandle = null;

    function attachJanusPlugin() {
      // Instruct server to attach the µStreamer plugin.
      janus.attach({
        // Qualifier of the plugin.
        plugin: "janus.plugin.ustreamer",

        // Callback function, when the server attached the plugin successfully.
        success: function (pluginHandle) {
          janusPluginHandle = pluginHandle;
          // Instruct the µStreamer plugin to initiate H.264 stream.
          janusPluginHandle.send({ message: { request: "watch" } });
        },

        // Callback function, when the server failed to attach the plugin.
        error: console.error,

        // Callback function, when a message arrived from the server.
        onmessage: function (msg, jsepOffer) {
          // Retry watch request, until the H.264 stream is available.
          if (msg.error_code === 503) {
            janusPluginHandle.send({ message: { request: "watch" } });
            return;
          }

          // Once the JSEP offer is there, instruct the server to start the
          // delivery of the H.264 stream.
          if (jsepOffer) {
            janusPluginHandle.createAnswer({
              jsep: jsepOffer,
              media: { audioSend: false, videoSend: false, data: false },
              success: function (jsepAnswer) {
                janusPluginHandle.send({
                  message: { request: "start" },
                  jsep: jsepAnswer,
                });
              },
              error: console.error,
            });
          }
        },

        // Callback function, when the video stream has become available.
        onremotetrack: function (track, mediaId, isAdded) {
          // Remove the media track from the video element, if the stream was
          // stopped.
          if (!isAdded) {
            videoElement.srcObject = null;
            return;
          }

          // Attach the received media track to the video element.
          const stream = new MediaStream();
          stream.addTrack(track.clone());
          videoElement.srcObject = stream;
        },
      });
    }
  </script>
</body>
</html>
```
